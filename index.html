<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Battle Run</title>
    <style>
        :root { --bg: #161512; --accent: #dbac16; --success: #629924; }
        body { background: var(--bg); color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { background: #262421; border-radius: 10px; padding: 20px; max-width: 450px; margin: 0 auto; border-top: 5px solid var(--accent); shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .status { margin: 15px 0; font-weight: bold; }
        .user-card { background: #302e2c; padding: 15px; border-radius: 5px; display: none; margin-top: 20px; }
        button { background: #45a049; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .error { color: #ff4444; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 5px; display: none; }

        .loader { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>CHESS BATTLE RUN</h1>
        
        <div id="status-box" class="status">
            <span class="loader"></span>
            <span id="status-text">Initialisation...</span>
        </div>
        <div id="error-box" class="error"></div>

        <div id="user-info" class="user-card">
            <p>Bienvenue, <span id="username" style="color:var(--accent); font-size: 1.2em;"></span> !</p>
            <p style="font-size: 0.9em; opacity: 0.8;">Connexion active avec Lichess API</p>
            <button onclick="resetConnection()" style="background:#8b0000;">Déconnexion</button>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status-text');
        const loaderEl = document.querySelector('.loader');

        let TOKEN = localStorage.getItem('CHESS_BATTLE_TOKEN');

        async function startEngine() {
            if (!TOKEN) {
                // ... (le code du prompt reste inchangé) ...
            }

            try {
                // --- UTILISATION DU PROXY CORS COMME DERNIÈRE SOLUTION ---
                const proxyUrl = 'https://cors-anywhere.herokuapp.com';
                const targetUrl = 'https://lichess.org';
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + TOKEN,
                        'Accept': 'application/json'
                    }
                });
                // ... (le reste du traitement des données reste inchangé) ...
                if (!response.ok) throw new Error("Erreur de connexion réseau via Proxy.");

                const data = await response.json();
                
                loaderEl.style.display = 'none';
                statusEl.innerHTML = "<span style='color:#629924;'>Système Prêt</span>";
                document.getElementById('username').innerText = data.username;
                document.getElementById('user-info').style.display = 'block';

            } catch (error) {
                loaderEl.style.display = 'none';
                document.getElementById('status-box').innerHTML = "<span style='color:#ff4444;'>Erreur système</span>";
                document.getElementById('error-box').innerText = error.message;
                document.getElementById('error-box').style.display = 'block';
                
                if (error.message.includes("401")) {
                    localStorage.removeItem('CHESS_BATTLE_TOKEN');
                }
            }
        }
        
        function resetConnection() { /* ... (fonction de déconnexion inchangée) ... */ }
        window.onload = startEngine;
    </script>
</body>
</html>

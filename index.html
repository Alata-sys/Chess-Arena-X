<script>
const statusEl = documen<script>
const statusEl = document.getElementById('status-text');
const userEl = document.getElementById('user-info');
const errorEl = document.getElementById('error-box');
const loaderEl = document.querySelector('.chess-loader');

let TOKEN = localStorage.getItem('CHESS_BATTLE_TOKEN');

function showError(msg){
    loaderEl.style.display = 'none';
    statusEl.innerHTML = "Erreur systÃ¨me";
    errorEl.innerText = msg;
    errorEl.style.display = 'block';
}

async function startEngine() {
    statusEl.innerHTML = "Boot Engine...";

    // ðŸ”¹ Service Worker (optionnel)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('Service Worker Registered'))
        .catch(err => console.log(err));
    }

    // ðŸ”¹ Skip API pour tester le menu si token absent ou mobile
    if (!TOKEN || TOKEN.length < 20) {
        loaderEl.style.display = 'none';
        TOKEN = prompt("ðŸ”‘ CONFIGURATION CHESS BATTLE RUN\nColle ton Token Lichess ici :");

        if (!TOKEN || TOKEN.trim().length < 20) {
            statusEl.innerHTML = "Jeton manquant... Redirection vers menu.";
            // Redirection directe vers le menu
            setTimeout(() => { window.location.href = 'index.html'; }, 500);
            return;
        } else {
            localStorage.setItem('CHESS_BATTLE_TOKEN', TOKEN.trim());
            location.reload();
            return;
        }
    }

    try {
        statusEl.innerHTML = "Connexion API...";

        // ðŸ”¹ Timeout pour fetch
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 8000);

        const response = await fetch('https://lichess.org/api/account', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + TOKEN,
                'Accept': 'application/json'
            },
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (response.status === 401) throw new Error("Token invalide.");
        if (!response.ok) throw new Error("Serveur Lichess indisponible.");

        const data = await response.json();

        // ðŸ”¹ Affichage du succÃ¨s
        loaderEl.style.display = 'none';
        statusEl.innerHTML = "SystÃ¨me PrÃªt âœ”";
        document.getElementById('username').innerText = data.username;
        userEl.style.display = 'block';

        // ðŸ”¹ Redirection automatique vers le menu
        setTimeout(() => { window.location.href = 'index.html'; }, 1000);

    } catch (error) {
        if(error.name === "AbortError"){
            showError("Temps dÃ©passÃ© rÃ©seau. Redirection vers menu...");
        } else {
            showError(error.message + " Redirection vers menu...");
        }

        localStorage.removeItem('CHESS_BATTLE_TOKEN');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
    }
}

function resetConnection() {
    if(confirm("Supprimer le Token local ?")) {
        localStorage.removeItem('CHESS_BATTLE_TOKEN');
        location.reload();
    }
}

window.onload = startEngine;
</script>ï¿¼Enter
